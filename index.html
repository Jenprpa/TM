<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity OS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Custom font and scrollbar for better look and feel */
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap');
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
        }
        /* For Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { createClient } = supabase;

        // --- SUPABASE CLIENT SETUP ---
        const supabaseUrl = 'https://raghhaggiefujvahpjvv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhZ2hoYWdnaWVmdWp2YWhwanZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNTExMDcsImV4cCI6MjA2OTcyNzEwN30.jV2X7K1RboM2dcF8biZIgTUz8HdoQ5E8s5WauGCH9PI';
        const sbClient = createClient(supabaseUrl, supabaseKey);

        // --- ICONS (SVG Components) ---
        const FolderIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>;
        const BriefcaseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>;
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>;
        const CalendarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const LayoutDashboardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><rect width="7" height="9" x="3" y="3" rx="1"></rect><rect width="7" height="5" x="14" y="3" rx="1"></rect><rect width="7" height="9" x="14" y="12" rx="1"></rect><rect width="7" height="5" x="3" y="16" rx="1"></rect></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;

        // --- DATA STRUCTURES & CONSTANTS ---
        const EISENHOWER_MATRIX = {
            'IMPORTANT_URGENT': { label: 'Do First', color: 'bg-red-500', borderColor: 'border-red-600' },
            'IMPORTANT_NOT_URGENT': { label: 'Schedule', color: 'bg-blue-500', borderColor: 'border-blue-600' },
            'NOT_IMPORTANT_URGENT': { label: 'Delegate', color: 'bg-yellow-500', borderColor: 'border-yellow-600' },
            'NOT_IMPORTANT_NOT_URGENT': { label: 'Eliminate', color: 'bg-gray-500', borderColor: 'border-gray-600' },
        };
        const KANBAN_STATUSES = { 'todo': 'To Do', 'inprogress': 'In Progress', 'done': 'Done' };

        // --- HELPER COMPONENTS ---
        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg relative text-white">
                    <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white">
                        <XIcon />
                    </button>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );

        const Spinner = () => (
            <div className="flex justify-center items-center h-full">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        );

        // --- MAIN APP COMPONENT ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [areas, setAreas] = useState([]);
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [notes, setNotes] = useState([]);
            const [selectedProject, setSelectedProject] = useState(null);
            const [modal, setModal] = useState({ type: null, data: null });

            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const { data: areasData, error: areasError } = await sbClient.from('areas').select('*');
                    if (areasError) throw areasError;
                    setAreas(areasData || []);

                    const { data: projectsData, error: projectsError } = await sbClient.from('projects').select('*');
                    if (projectsError) throw projectsError;
                    setProjects(projectsData || []);

                    const { data: tasksData, error: tasksError } = await sbClient.from('tasks').select('*');
                    if (tasksError) throw tasksError;
                    setTasks(tasksData || []);

                    const { data: notesData, error: notesError } = await sbClient.from('notes').select('*');
                    if (notesError) throw notesError;
                    setNotes(notesData || []);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('ไม่สามารถโหลดข้อมูลได้: ' + error.message);
                } finally {
                    setLoading(false);
                }
            }, []);

            // Fetch data from Supabase when the app starts
            useEffect(() => {
                fetchData();
            }, [fetchData]);

            const handleUpsert = async (table, data) => {
                const { data: result, error } = await sbClient.from(table).upsert(data).select();
                if (error) {
                    alert(`เกิดข้อผิดพลาดในการบันทึก ${table}: ${error.message}`);
                    return null;
                }
                fetchData(); // Refresh data from DB
                setModal({ type: null, data: null });
                return result[0];
            };

            const handleDelete = async (table, id) => {
                if (window.confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                    // Handle cascading deletes for related items first
                    if (table === 'areas') {
                        const projectsInArea = projects.filter(p => p.area_id === id);
                        for (const project of projectsInArea) {
                            await handleDelete('projects', project.id); // This will recursively delete tasks and notes
                        }
                    }
                    if (table === 'projects') {
                         const tasksInProject = tasks.filter(t => t.project_id === id);
                         for (const task of tasksInProject) {
                            await sbClient.from('tasks').delete().match({ id: task.id });
                         }
                         const notesInProject = notes.filter(n => n.project_id === id);
                         for (const note of notesInProject) {
                            await sbClient.from('notes').delete().match({ id: note.id });
                         }
                    }

                    // Delete the main item
                    const { error } = await sbClient.from(table).delete().match({ id });
                    if (error) {
                        alert(`เกิดข้อผิดพลาดในการลบ ${table}: ${error.message}`);
                    } else {
                        fetchData(); // Refresh data from DB
                        // If deleting the currently selected project or its area, go back to dashboard
                        if (table === 'projects' && selectedProject?.id === id) {
                            setSelectedProject(null);
                            setView('dashboard');
                        }
                        if (table === 'areas' && selectedProject?.area_id === id) {
                            setSelectedProject(null);
                            setView('dashboard');
                        }
                    }
                }
            };

            const openProject = (project) => {
                setSelectedProject(project);
                setView('project');
            };

            const navigateToDashboard = () => {
                setSelectedProject(null);
                setView('dashboard');
            };

            if (loading) {
                return (
                    <div className="bg-gray-900 text-white min-h-screen flex items-center justify-center">
                        <Spinner />
                    </div>
                );
            }

            return (
                <div className="text-white min-h-screen flex">
                    <nav className="w-64 bg-gray-950 p-4 flex flex-col border-r border-gray-800 flex-shrink-0">
                        <h1 className="text-2xl font-bold text-blue-400 mb-8">Productivity OS</h1>
                        <ul className="space-y-2">
                            <li><button onClick={navigateToDashboard} className={`w-full flex items-center gap-3 p-2 rounded-md ${view === 'dashboard' ? 'bg-blue-500 text-white' : 'hover:bg-gray-800'}`}><LayoutDashboardIcon /> แดชบอร์ด</button></li>
                            <li><button onClick={() => setView('calendar')} className={`w-full flex items-center gap-3 p-2 rounded-md ${view === 'calendar' ? 'bg-blue-500 text-white' : 'hover:bg-gray-800'}`}><CalendarIcon /> ปฏิทิน</button></li>
                        </ul>
                        <div className="mt-auto"><p className="text-xs text-gray-500">สร้างโดยใช้หลักการ Eisenhower, Kanban, และ Second Brain</p></div>
                    </nav>
                    <main className="flex-1 p-6 md:p-8 overflow-auto">
                        {view === 'dashboard' && <DashboardView areas={areas} projects={projects} onAddArea={() => setModal({type: 'add-area'})} onEditArea={(area) => setModal({type: 'edit-area', data: area})} onDeleteArea={(id) => handleDelete('areas', id)} onAddProject={(areaId) => setModal({type: 'add-project', data: { area_id: areaId }})} onEditProject={(project) => setModal({type: 'edit-project', data: project})} onDeleteProject={(id) => handleDelete('projects', id)} onOpenProject={openProject} />}
                        {view === 'project' && selectedProject && <ProjectView project={selectedProject} tasks={tasks.filter(t => t.project_id === selectedProject.id)} notes={notes.filter(n => n.project_id === selectedProject.id)} onAddTask={() => setModal({type: 'add-task', data: { project_id: selectedProject.id }})} onEditTask={(task) => setModal({type: 'edit-task', data: task})} onDeleteTask={(id) => handleDelete('tasks', id)} onAddNote={() => setModal({type: 'add-note', data: { project_id: selectedProject.id }})} onEditNote={(note) => setModal({type: 'edit-note', data: note})} onDeleteNote={(id) => handleDelete('notes', id)} onTaskStatusChange={(task, newStatus) => handleUpsert('tasks', {...task, status: newStatus})} />}
                        {view === 'calendar' && <CalendarView tasks={tasks} />}
                    </main>
                    {modal.type && (
                        <Modal onClose={() => setModal({ type: null, data: null })}>
                            { (modal.type === 'add-area' || modal.type === 'edit-area') && <AreaForm initialData={modal.data} onSubmit={(data) => handleUpsert('areas', data)} onCancel={() => setModal({ type: null, data: null })} /> }
                            { (modal.type === 'add-project' || modal.type === 'edit-project') && <ProjectForm initialData={modal.data} areas={areas} onSubmit={(data) => handleUpsert('projects', data)} onCancel={() => setModal({ type: null, data: null })} /> }
                            { (modal.type === 'add-task' || modal.type === 'edit-task') && <TaskForm initialData={modal.data} projects={projects} onSubmit={(data) => handleUpsert('tasks', data)} onCancel={() => setModal({ type: null, data: null })} /> }
                            { (modal.type === 'add-note' || modal.type === 'edit-note') && <NoteForm initialData={modal.data} projects={projects} onSubmit={(data) => handleUpsert('notes', data)} onCancel={() => setModal({ type: null, data: null })} /> }
                        </Modal>
                    )}
                </div>
            );
        }

        // --- VIEW COMPONENTS ---
        const DashboardView = ({ areas, projects, onAddArea, onEditArea, onDeleteArea, onAddProject, onEditProject, onDeleteProject, onOpenProject }) => (
            <div>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-3xl font-bold">แดชบอร์ด</h2>
                    <button onClick={onAddArea} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2"><PlusIcon /> สร้าง Area ใหม่</button>
                </div>
                <div className="space-y-8">
                    {areas.length > 0 ? areas.map(area => (
                        <div key={area.id} className="bg-gray-800/50 p-4 rounded-lg">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3"><FolderIcon /><h3 className="text-xl font-semibold text-blue-300">{area.name}</h3></div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => onAddProject(area.id)} className="text-gray-400 hover:text-white p-1 rounded-md bg-gray-700 hover:bg-gray-600"><PlusIcon /></button>
                                    <button onClick={() => onEditArea(area)} className="text-gray-400 hover:text-white p-1 rounded-md bg-gray-700 hover:bg-gray-600"><EditIcon /></button>
                                    <button onClick={() => onDeleteArea(area.id)} className="text-gray-400 hover:text-red-500 p-1 rounded-md bg-gray-700 hover:bg-red-600"><TrashIcon /></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {projects.filter(p => p.area_id === area.id).map(project => (
                                    <div key={project.id} className="bg-gray-800 p-4 rounded-md shadow-md hover:shadow-lg hover:border-blue-500 border border-transparent transition-all duration-200 group">
                                        <div className="flex justify-between items-start">
                                            <button onClick={() => onOpenProject(project)} className="w-full text-left">
                                                <div className="flex items-center gap-2 mb-2"><BriefcaseIcon /><h4 className="font-bold text-lg group-hover:text-blue-400">{project.name}</h4></div>
                                                <p className="text-sm text-gray-400 line-clamp-2">{project.description || 'ไม่มีคำอธิบาย'}</p>
                                            </button>
                                            <div className="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => onEditProject(project)} className="text-gray-400 hover:text-white"><EditIcon /></button>
                                                <button onClick={() => onDeleteProject(project.id)} className="text-gray-400 hover:text-red-500"><TrashIcon /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => onAddProject(area.id)} className="border-2 border-dashed border-gray-600 rounded-md text-gray-500 hover:text-white hover:border-gray-500 transition flex flex-col items-center justify-center p-4 min-h-[120px]"><PlusIcon /><span>สร้างโปรเจคใหม่</span></button>
                            </div>
                        </div>
                    )) : (<div className="text-center py-16 bg-gray-800/50 rounded-lg"><p className="text-gray-400">ยังไม่มี Area</p><p className="text-gray-500 text-sm mt-2">เริ่มต้นด้วยการสร้าง Area เพื่อจัดหมวดหมู่โปรเจคของคุณ</p></div>)}
                </div>
            </div>
        );

        const ProjectView = ({ project, tasks, notes, onAddTask, onEditTask, onDeleteTask, onAddNote, onEditNote, onDeleteNote, onTaskStatusChange }) => {
            const columns = Object.keys(KANBAN_STATUSES);
            const handleDragStart = (e, task) => e.dataTransfer.setData("taskId", task.id);
            const handleDrop = (e, status) => {
                const taskId = e.dataTransfer.getData("taskId");
                const task = tasks.find(t => t.id === parseInt(taskId));
                if (task && task.status !== status) onTaskStatusChange(task, status);
            };
            const handleDragOver = (e) => e.preventDefault();
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-1">{project.name}</h2>
                    <p className="text-gray-400 mb-6">{project.description}</p>
                    <div className="mb-8">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-2xl font-semibold">Kanban Board</h3><button onClick={onAddTask} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2"><PlusIcon /> สร้าง Task ใหม่</button></div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {columns.map(status => (
                                <div key={status} className="bg-gray-800/50 rounded-lg p-3" onDrop={(e) => handleDrop(e, status)} onDragOver={handleDragOver}>
                                    <h4 className="font-bold text-center mb-4 text-lg">{KANBAN_STATUSES[status]}</h4>
                                    <div className="space-y-3 min-h-[200px]">
                                        {tasks.filter(t => t.status === status).map(task => (
                                            <div key={task.id} draggable onDragStart={(e) => handleDragStart(e, task)} className={`bg-gray-800 p-3 rounded-md shadow-md cursor-grab border-l-4 ${EISENHOWER_MATRIX[task.priority]?.borderColor || 'border-gray-500'} group`}>
                                                <div className="flex justify-between items-start">
                                                    <p className="font-semibold">{task.title}</p>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => onEditTask(task)} className="text-gray-400 hover:text-white"><EditIcon /></button>
                                                        <button onClick={() => onDeleteTask(task.id)} className="text-gray-400 hover:text-red-500"><TrashIcon /></button>
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-400 mt-1">{task.description}</p>
                                                <div className="flex justify-between items-center mt-2">
                                                    <span className={`text-xs font-semibold px-2 py-1 rounded-full text-white ${EISENHOWER_MATRIX[task.priority]?.color || 'bg-gray-500'}`}>{EISENHOWER_MATRIX[task.priority]?.label || 'No Priority'}</span>
                                                    {task.due_date && <span className="text-xs text-gray-500">{new Date(task.due_date).toLocaleDateString('th-TH')}</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div>
                        <div className="flex justify-between items-center mb-4"><h3 className="text-2xl font-semibold">Notes (Second Brain)</h3><button onClick={onAddNote} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2"><PlusIcon /> เพิ่ม Note</button></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {notes.map(note => (
                                <div key={note.id} className="bg-yellow-200 text-gray-800 p-4 rounded-md shadow-md relative group">
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => onEditNote(note)} className="text-gray-600 hover:text-black"><EditIcon /></button>
                                        <button onClick={() => onDeleteNote(note.id)} className="text-gray-600 hover:text-red-700"><TrashIcon /></button>
                                    </div>
                                    <p className="whitespace-pre-wrap">{note.content}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ tasks }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(startOfMonth);
            startDate.setDate(startDate.getDate() - startOfMonth.getDay());
            const endDate = new Date(endOfMonth);
            endDate.setDate(endDate.getDate() + (6 - endOfMonth.getDay()));
            const days = [];
            let day = new Date(startDate);
            while (day <= endDate) {
                days.push(new Date(day));
                day.setDate(day.getDate() + 1);
            }
            const tasksByDate = useMemo(() => {
                const map = {};
                tasks.forEach(task => {
                    if (task.due_date) {
                        const dateStr = new Date(task.due_date).toISOString().split('T')[0];
                        if (!map[dateStr]) map[dateStr] = [];
                        map[dateStr].push(task);
                    }
                });
                return map;
            }, [tasks]);
            const changeMonth = (offset) => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">ปฏิทิน</h2>
                        <div className="flex items-center gap-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 rounded-md hover:bg-gray-800">‹</button>
                            <span className="text-xl font-semibold w-48 text-center">{currentDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 rounded-md hover:bg-gray-800">›</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-px bg-gray-700 border border-gray-700 rounded-lg overflow-hidden">
                        {['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'].map(dayName => <div key={dayName} className="text-center font-semibold p-2 bg-gray-800 text-gray-300">{dayName}</div>)}
                        {days.map(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const tasksForDay = tasksByDate[dateStr] || [];
                            const isCurrentMonth = d.getMonth() === currentDate.getMonth();
                            const isToday = new Date().toISOString().split('T')[0] === dateStr;
                            return (
                                <div key={dateStr} className={`p-2 h-36 overflow-y-auto bg-gray-900 ${isCurrentMonth ? '' : 'bg-gray-900/50 text-gray-500'}`}>
                                    <div className={`font-bold mb-1 ${isToday ? 'text-blue-400' : ''}`}>{d.getDate()}</div>
                                    <div className="space-y-1">{tasksForDay.map(task => <div key={task.id} className={`text-xs p-1 rounded-md text-white ${EISENHOWER_MATRIX[task.priority]?.color}`}>{task.title}</div>)}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- FORM COMPONENTS ---
        const AreaForm = ({ initialData, onSubmit, onCancel }) => {
            const [name, setName] = useState(initialData?.name || '');
            const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return alert('กรุณาใส่ชื่อ Area'); onSubmit({ id: initialData?.id, name }); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h3 className="text-xl font-bold">{initialData ? 'แก้ไข Area' : 'สร้าง Area ใหม่'}</h3>
                    <div>
                        <label htmlFor="area-name" className="block text-sm font-medium text-gray-300 mb-1">ชื่อ Area</label>
                        <input id="area-name" type="text" value={name} onChange={e => setName(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น งาน, ส่วนตัว, การเรียน" />
                    </div>
                    <div className="flex justify-end gap-2"><button type="button" onClick={onCancel} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">ยกเลิก</button><button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button></div>
                </form>
            );
        };

        const ProjectForm = ({ initialData, areas, onSubmit, onCancel }) => {
            const [name, setName] = useState(initialData?.name || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [areaId, setAreaId] = useState(initialData?.area_id || '');
            const handleSubmit = (e) => { e.preventDefault(); if (!name.trim() || !areaId) return alert('กรุณาใส่ชื่อโปรเจคและเลือก Area'); onSubmit({ id: initialData?.id, name, description, area_id: areaId }); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h3 className="text-xl font-bold">{initialData?.id ? 'แก้ไขโปรเจค' : 'สร้างโปรเจคใหม่'}</h3>
                    <div><label htmlFor="project-name" className="block text-sm font-medium text-gray-300 mb-1">ชื่อโปรเจค</label><input id="project-name" type="text" value={name} onChange={e => setName(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" placeholder="เช่น พัฒนาแอปพลิเคชันใหม่" /></div>
                    <div><label htmlFor="project-desc" className="block text-sm font-medium text-gray-300 mb-1">คำอธิบาย (ไม่บังคับ)</label><textarea id="project-desc" value={description} onChange={e => setDescription(e.target.value)} rows="3" className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></textarea></div>
                    <div>
                        <label htmlFor="project-area" className="block text-sm font-medium text-gray-300 mb-1">Area</label>
                        <select id="project-area" value={areaId} onChange={e => setAreaId(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                            <option value="" disabled>-- เลือก Area --</option>
                            {areas.map(area => <option key={area.id} value={area.id}>{area.name}</option>)}
                        </select>
                    </div>
                    <div className="flex justify-end gap-2"><button type="button" onClick={onCancel} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">ยกเลิก</button><button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button></div>
                </form>
            );
        };

        const TaskForm = ({ initialData, projects, onSubmit, onCancel }) => {
            const [title, setTitle] = useState(initialData?.title || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [projectId, setProjectId] = useState(initialData?.project_id || '');
            const [dueDate, setDueDate] = useState(initialData?.due_date ? initialData.due_date.split('T')[0] : '');
            const [priority, setPriority] = useState(initialData?.priority || 'IMPORTANT_NOT_URGENT');
            const [status, setStatus] = useState(initialData?.status || 'todo');
            const handleSubmit = (e) => { e.preventDefault(); if (!title.trim() || !projectId) return alert('กรุณากรอกข้อมูลให้ครบถ้วน'); onSubmit({ id: initialData?.id, title, description, project_id: projectId, due_date: dueDate || null, priority, status }); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h3 className="text-xl font-bold">{initialData?.id ? 'แก้ไข Task' : 'สร้าง Task ใหม่'}</h3>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">โปรเจค</label>
                        <select value={projectId} onChange={e => setProjectId(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                            <option value="" disabled>-- เลือกโปรเจค --</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-300 mb-1">ชื่องาน</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" /></div>
                    <div><label className="block text-sm font-medium text-gray-300 mb-1">คำอธิบาย</label><textarea value={description} onChange={e => setDescription(e.target.value)} rows="3" className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></textarea></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium text-gray-300 mb-1">วันครบกำหนด</label><input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" /></div>
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-1">สถานะ (Kanban)</label>
                            <select value={status} onChange={e => setStatus(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                                {Object.entries(KANBAN_STATUSES).map(([key, label]) => <option key={key} value={key}>{label}</option>)}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">ความสำคัญ (Eisenhower)</label>
                        <select value={priority} onChange={e => setPriority(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                            {Object.entries(EISENHOWER_MATRIX).map(([key, { label }]) => <option key={key} value={key}>{label}</option>)}
                        </select>
                    </div>
                    <div className="flex justify-end gap-2"><button type="button" onClick={onCancel} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">ยกเลิก</button><button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button></div>
                </form>
            );
        };

        const NoteForm = ({ initialData, projects, onSubmit, onCancel }) => {
            const [content, setContent] = useState(initialData?.content || '');
            const [projectId, setProjectId] = useState(initialData?.project_id || '');
            const handleSubmit = (e) => { e.preventDefault(); if (!content.trim() || !projectId) return alert('กรุณากรอกข้อมูลให้ครบถ้วน'); onSubmit({ id: initialData?.id, content, project_id: projectId }); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h3 className="text-xl font-bold">{initialData?.id ? 'แก้ไข Note' : 'สร้าง Note ใหม่'}</h3>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">โปรเจคที่เกี่ยวข้อง</label>
                        <select value={projectId} onChange={e => setProjectId(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                            <option value="" disabled>-- เลือกโปรเจค --</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-300 mb-1">เนื้อหา</label><textarea value={content} onChange={e => setContent(e.target.value)} rows="6" className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" placeholder="จดบันทึกไอเดีย, ข้อมูล, หรือสิ่งที่น่าสนใจ..."></textarea></div>
                    <div className="flex justify-end gap-2"><button type="button" onClick={onCancel} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">ยกเลิก</button><button type="submit" className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">บันทึก Note</button></div>
                </form>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
