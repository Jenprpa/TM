<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Brain - Personal Knowledge Management</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react-beautiful-dnd@13.1.1/dist/react-beautiful-dnd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #CFE0EB 0%, #DAFAFA 100%);
            min-height: 100vh;
            color: #333;
        }
        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav {
            display: flex;
            gap: 20px;
        }
        .nav-btn {
            background: #78A3D4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #8BADD3;
            transform: translateY(-1px);
        }
        .nav-btn.active {
            background: #6A93C2;
            box-shadow: 0 0 10px rgba(120, 163, 212, 0.5);
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .priority-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .priority-card {
            background: linear-gradient(135deg, #78A3D4, #9DCAEB);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(120, 163, 212, 0.3);
        }
        .eisenhower-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .matrix-quadrant {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            border: 2px dashed #ccc;
            transition: background-color 0.3s;
        }
        .urgent-important { background: rgba(255, 192, 203, 0.3); border-color: #FFC0CB; }
        .urgent-not-important { background: rgba(255, 255, 0, 0.2); border-color: #F0E68C; }
        .not-urgent-important { background: rgba(120, 163, 212, 0.1); border-color: #78A3D4; }
        .not-urgent-not-important { background: rgba(200, 200, 200, 0.2); border-color: #ccc; }
        .task-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: grab;
        }
        .task-item:active { cursor: grabbing; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #78A3D4;
        }
        .btn {
            background: #78A3D4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .btn:hover { background: #8BADD3; transform: translateY(-1px); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .table-view { overflow-x: auto; }
        .table-view table { width: 100%; border-collapse: collapse; }
        .table-view th, .table-view td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table-view th { background: #f8f9fa; font-weight: 600; }
        .modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .priority-low { border-left: 4px solid #28a745; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-high { border-left: 4px solid #dc3545; }
        .view-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 1.2rem; }
        .error, .success { padding: 15px; border-radius: 8px; margin: 0 0 20px 0; text-align: center; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .completed { opacity: 0.6; text-decoration: line-through; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #9DCAEB, #AFD5F0); color: #033649; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

        // Supabase configuration
        const supabaseUrl = 'https://raghhaggiefujvahpjvv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhZ2hoYWdnaWVmdWp2YWhwanZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNTExMDcsImV4cCI6MjA2OTcyNzEwN30.jV2X7K1RboM2dcF8biZIgTUz8HdoQ5E8s5WauGCH9PI';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Main App Component
        function App() {
            const [currentView, setCurrentView] = useState('dashboard');
            const [areas, setAreas] = useState([]);
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [notes, setNotes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const loadData = useCallback(async () => {
                try {
                    setLoading(true);
                    setError('');
                    
                    const [areasRes, projectsRes, tasksRes, notesRes] = await Promise.all([
                        supabase.from('areas').select('*').order('updated_at', { ascending: false }),
                        supabase.from('projects').select('*').order('updated_at', { ascending: false }),
                        supabase.from('tasks').select('*').order('updated_at', { ascending: false }),
                        supabase.from('notes').select('*').order('updated_at', { ascending: false })
                    ]);

                    const checkError = (res, name) => { if (res.error) throw new Error(`Failed to load ${name}: ${res.error.message}`); return res.data || []; };
                    const areasData = checkError(areasRes, 'areas');
                    const projectsData = checkError(projectsRes, 'projects');
                    const tasksData = checkError(tasksRes, 'tasks');
                    const notesData = checkError(notesRes, 'notes');

                    const projectsWithAreas = projectsData.map(p => ({ ...p, area: p.area_id ? areasData.find(a => a.id === p.area_id) : null }));
                    const tasksWithRelations = tasksData.map(t => {
                        const project = projectsWithAreas.find(p => p.id === t.project_id);
                        return { ...t, project, area: t.area_id ? areasData.find(a => a.id === t.area_id) : (project ? project.area : null) };
                    });
                    const notesWithRelations = notesData.map(n => ({ ...n, project: n.project_id ? projectsWithAreas.find(p => p.id === n.project_id) : null, area: n.area_id ? areasData.find(a => a.id === n.area_id) : null }));

                    setAreas(areasData);
                    setProjects(projectsWithAreas);
                    setTasks(tasksWithRelations);
                    setNotes(notesWithRelations);

                } catch (err) {
                    console.error("‚ùå Load data error:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, []);

            const checkAutoPromotion = useCallback(async () => {
                try {
                    const threeDaysFromNow = new Date();
                    threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
                    
                    const tasksToPromote = tasks.filter(task => 
                        task.category === 'not-urgent-important' && task.due_date && new Date(task.due_date) <= threeDaysFromNow && task.status !== 'completed'
                    );

                    if (tasksToPromote.length > 0) {
                        const updates = tasksToPromote.map(task => supabase.from('tasks').update({ category: 'urgent-important' }).eq('id', task.id));
                        await Promise.all(updates);
                        showMessage(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${tasksToPromote.length} ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡πâ‡∏ß`);
                        loadData();
                    }
                } catch (err) {
                    console.error('Auto-promotion error:', err);
                }
            }, [tasks, loadData]);

            useEffect(() => {
                loadData();
                const interval = setInterval(checkAutoPromotion, 3600000);
                return () => clearInterval(interval);
            }, [loadData, checkAutoPromotion]);

            const showMessage = (message, type = 'success') => {
                (type === 'success' ? setSuccess : setError)(message);
                setTimeout(() => { setSuccess(''); setError(''); }, 4000);
            };
            
            const renderView = () => {
                if (loading) return <div className="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;
                const props = { onUpdate: loadData, showMessage, areas, projects, tasks, notes };
                switch (currentView) {
                    case 'dashboard': return <Dashboard {...props} />;
                    case 'tasks': return <TaskManager {...props} />;
                    case 'projects': return <ProjectManager {...props} />;
                    case 'areas': return <AreaManager {...props} />;
                    case 'notes': return <NoteManager {...props} />;
                    default: return <Dashboard {...props} />;
                }
            };

            return (
                <div className="app">
                    <header className="header">
                        <h1 style={{ color: '#78A3D4', fontSize: '2rem' }}>üß† Second Brain</h1>
                        <nav className="nav">
                            <button className={`nav-btn ${currentView === 'dashboard' ? 'active' : ''}`} onClick={() => setCurrentView('dashboard')}>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                            <button className={`nav-btn ${currentView === 'tasks' ? 'active' : ''}`} onClick={() => setCurrentView('tasks')}>‡∏á‡∏≤‡∏ô</button>
                            <button className={`nav-btn ${currentView === 'projects' ? 'active' : ''}`} onClick={() => setCurrentView('projects')}>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</button>
                            <button className={`nav-btn ${currentView === 'areas' ? 'active' : ''}`} onClick={() => setCurrentView('areas')}>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
                            <button className={`nav-btn ${currentView === 'notes' ? 'active' : ''}`} onClick={() => setCurrentView('notes')}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </nav>
                    </header>
                    {error && <div className="error">{error}</div>}
                    {success && <div className="success">{success}</div>}
                    {renderView()}
                </div>
            );
        }

        function Dashboard({ tasks, areas, projects, notes, onUpdate, showMessage }) {
            const highPriorityTasks = tasks.filter(t => t.priority === 'high' && t.status !== 'completed').sort((a, b) => new Date(a.due_date || '9999-12-31') - new Date(b.due_date || '9999-12-31')).slice(0, 3);
            const tasksByCategory = {
                'urgent-important': tasks.filter(t => t.category === 'urgent-important' && t.status !== 'completed'),
                'not-urgent-important': tasks.filter(t => t.category === 'not-urgent-important' && t.status !== 'completed'),
                'urgent-not-important': tasks.filter(t => t.category === 'urgent-not-important' && t.status !== 'completed'),
                'not-urgent-not-important': tasks.filter(t => t.category === 'not-urgent-not-important' && t.status !== 'completed')
            };
            const completedTasks = tasks.filter(task => task.status === 'completed');

            const handleDragEnd = async (result) => {
                if (!result.destination) return;
                const { draggableId, destination } = result;
                try {
                    const { error } = await supabase.from('tasks').update({ category: destination.droppableId }).eq('id', draggableId);
                    if (error) throw error;
                    showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    onUpdate();
                } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error'); }
            };
            
            const toggleTaskComplete = async (task) => {
                try {
                    const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                    const { error } = await supabase.from('tasks').update({ status: newStatus, completed_at: newStatus === 'completed' ? new Date().toISOString() : null }).eq('id', task.id);
                    if (error) throw error;
                    showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    onUpdate();
                } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error'); }
            };

            return (
                <div>
                    <div className="stats">
                        <div className="stat-card"><div className="stat-number">{areas.length}</div><div className="stat-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div></div>
                        <div className="stat-card"><div className="stat-number">{projects.length}</div><div className="stat-label">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</div></div>
                        <div className="stat-card"><div className="stat-number">{tasks.filter(t => t.status !== 'completed').length}</div><div className="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</div></div>
                        <div className="stat-card"><div className="stat-number">{completedTasks.length}</div><div className="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div></div>
                        <div className="stat-card"><div className="stat-number">{notes.length}</div><div className="stat-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div></div>
                    </div>
                    <div className="card">
                        <h2 style={{ color: '#78A3D4', marginBottom: '20px' }}>üî• ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (Top 3)</h2>
                        <div className="priority-cards">
                            {highPriorityTasks.length > 0 ? highPriorityTasks.map(task => (
                                <div key={task.id} className="priority-card">
                                    <h3>{task.title}</h3>
                                    <p>{task.description}</p>
                                    <p><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</strong> {task.due_date ? new Date(task.due_date).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                                    <p><strong>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ:</strong> {task.project?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                                    <button className="btn btn-success" onClick={() => toggleTaskComplete(task)} style={{ marginTop: '10px' }}>‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                                </div>
                            )) : <div className="priority-card"><h3>üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</h3><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p></div>}
                        </div>
                    </div>
                    <div className="card">
                        <h2 style={{ color: '#78A3D4', marginBottom: '20px' }}>üìä Eisenhower Matrix</h2>
                        <DragDropContext onDragEnd={handleDragEnd}>
                            <div className="eisenhower-matrix">
                                {Object.entries(tasksByCategory).map(([category, categoryTasks]) => (
                                    <Droppable key={category} droppableId={category}>
                                        {(provided) => (
                                            <div ref={provided.innerRef} {...provided.droppableProps} className={`matrix-quadrant ${category}`}>
                                                <h3 style={{ marginBottom: '15px', textAlign: 'center' }}>
                                                    {category === 'urgent-important' && 'üî• ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô + ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'}
                                                    {category === 'not-urgent-important' && 'üìÖ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô + ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'}
                                                    {category === 'urgent-not-important' && '‚ö° ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô + ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'}
                                                    {category === 'not-urgent-not-important' && 'üóëÔ∏è ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô + ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'}
                                                </h3>
                                                {categoryTasks.map((task, index) => (
                                                    <Draggable key={task.id.toString()} draggableId={task.id.toString()} index={index}>
                                                        {(provided) => (
                                                            <div ref={provided.innerRef} {...provided.draggableProps} {...provided.dragHandleProps} className={`task-item priority-${task.priority}`}>
                                                                <h4>{task.title}</h4>
                                                                <p style={{ fontSize: '0.9rem', opacity: 0.8 }}>{task.project?.name || 'N/A'}</p>
                                                            </div>
                                                        )}
                                                    </Draggable>
                                                ))}
                                                {provided.placeholder}
                                            </div>
                                        )}
                                    </Droppable>
                                ))}
                            </div>
                        </DragDropContext>
                    </div>
                </div>
            );
        }

        async function handleDeleteItem(id, table, onUpdate, showMessage) {
            if (!window.confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) return;
            try {
                const { error } = await supabase.from(table).delete().eq('id', id);
                if (error) throw error;
                showMessage(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`);
                onUpdate();
            } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${err.message}`, 'error'); }
        }

        function TaskManager({ tasks, projects, areas, onUpdate, showMessage }) {
            const [showModal, setShowModal] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const initialFormState = { title: '', description: '', due_date: '', priority: 'medium', category: 'not-urgent-important', status: 'pending', project_id: '', area_id: '' };
            const [formData, setFormData] = useState(initialFormState);

            const handleNew = () => { setEditingTask(null); setFormData(initialFormState); setShowModal(true); };
            const handleEdit = (task) => { setEditingTask(task); setFormData({ title: task.title, description: task.description || '', due_date: task.due_date || '', priority: task.priority, category: task.category, status: task.status || 'pending', project_id: task.project_id || '', area_id: task.area_id || '' }); setShowModal(true); };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const data = { ...formData, project_id: formData.project_id || null, area_id: formData.area_id || null, due_date: formData.due_date || null };
                    const { error } = editingTask ? await supabase.from('tasks').update(data).eq('id', editingTask.id) : await supabase.from('tasks').insert([data]);
                    if (error) throw error;
                    showMessage(editingTask ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    setShowModal(false); onUpdate();
                } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error'); }
            };
            
            const toggleComplete = async (task) => {
                try {
                    const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                    const { error } = await supabase.from('tasks').update({ status: newStatus, completed_at: newStatus === 'completed' ? new Date().toISOString() : null }).eq('id', task.id);
                    if (error) throw error;
                    showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); onUpdate();
                } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error'); }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h2 style={{ color: '#78A3D4' }}>‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h2>
                            <button className="btn" onClick={handleNew}>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                        <div className="table-view">
                            <table>
                                <thead><tr><th>‡∏á‡∏≤‡∏ô</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th><th>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody>
                                    {tasks.map(task => (
                                        <tr key={task.id} className={task.status === 'completed' ? 'completed' : ''}>
                                            <td><strong>{task.title}</strong>{task.description && <div style={{ fontSize: '0.9rem', opacity: 0.7 }}>{task.description}</div>}</td>
                                            <td>{task.due_date ? new Date(task.due_date).toLocaleDateString('th-TH') : '-'}</td>
                                            <td><span className={`priority-${task.priority}`}>{task.priority}</span></td>
                                            <td>{task.project?.name || '-'}</td>
                                            <td><button className={`btn ${task.status === 'completed' ? 'btn-warning' : 'btn-success'}`} onClick={() => toggleComplete(task)}>{task.status === 'completed' ? '‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à'}</button></td>
                                            <td>
                                                <button className="btn" onClick={() => handleEdit(task)}>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                                <button className="btn btn-danger" onClick={() => handleDeleteItem(task.id, 'tasks', onUpdate, showMessage)}>üóëÔ∏è ‡∏•‡∏ö</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {showModal && <div className="modal">
                        <div className="modal-content">
                            <h3>{editingTask ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'}</h3>
                            <form onSubmit={handleSubmit}>
                                <div className="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô *</label><input type="text" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} required/></div>
                                <div className="form-group"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} rows="3"/></div>
                                <div className="form-group"><label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label><input type="date" value={formData.due_date} onChange={(e) => setFormData({...formData, due_date: e.target.value})}/></div>
                                <div className="form-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><select value={formData.priority} onChange={(e) => setFormData({...formData, priority: e.target.value})}><option value="low">‡∏ï‡πà‡∏≥</option><option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="high">‡∏™‡∏π‡∏á</option></select></div>
                                <div className="form-group"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}><option value="urgent-important">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option><option value="not-urgent-important">‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option><option value="urgent-not-important">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option><option value="not-urgent-not-important">‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option></select></div>
                                <div className="form-group"><label>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</label><select value={formData.project_id} onChange={(e) => setFormData({...formData, project_id: e.target.value})}><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ --</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                                <div className="form-group"><label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ)</label><select value={formData.area_id} onChange={(e) => setFormData({...formData, area_id: e.target.value})}><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà --</option>{areas.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                                <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}><button type="button" className="btn" onClick={() => setShowModal(false)}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" className="btn btn-success">{editingTask ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡πÄ‡∏û‡∏¥‡πà‡∏°'}</button></div>
                            </form>
                        </div>
                    </div>}
                </div>
            );
        }

        function GenericManager({ title, items, table, fields, onUpdate, showMessage, areas = [], projects = [] }) {
            const [viewMode, setViewMode] = useState('grid');
            const [showModal, setShowModal] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const initialFormState = fields.reduce((acc, field) => ({ ...acc, [field.name]: field.initial || '' }), {});
            const [formData, setFormData] = useState(initialFormState);

            const handleNew = () => { setEditingItem(null); setFormData(initialFormState); setShowModal(true); };
            const handleEdit = (item) => { setEditingItem(item); const itemFormData = fields.reduce((acc, field) => ({ ...acc, [field.name]: item[field.name] || field.initial || '' }), {}); setFormData(itemFormData); setShowModal(true); };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const data = Object.keys(formData).reduce((acc, key) => { acc[key] = (key.endsWith('_id') && formData[key] === '') ? null : formData[key]; return acc; }, {});
                    const { error } = editingItem ? await supabase.from(table).update(data).eq('id', editingItem.id) : await supabase.from(table).insert([data]);
                    if (error) throw error;
                    showMessage(editingItem ? `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï${title}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢` : `‡πÄ‡∏û‡∏¥‡πà‡∏°${title}‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                    setShowModal(false); onUpdate();
                } catch (err) { showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error'); }
            };
            
            const renderField = (field) => {
                const commonProps = { value: formData[field.name], onChange: (e) => setFormData({ ...formData, [field.name]: e.target.value }) };
                switch (field.type) {
                    case 'textarea': return <textarea {...commonProps} rows="4" />;
                    case 'select':
                        const options = field.options === 'areas' ? areas : projects;
                        return (<select {...commonProps}><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å{field.label} --</option>{options.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}</select>);
                    case 'select-static':
                        return (<select {...commonProps}>{field.options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select>);
                    default: return <input type={field.type || 'text'} {...commonProps} required={field.required} />;
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h2 style={{ color: '#78A3D4' }}>{title}</h2>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <div className="view-toggle"><button className={`btn ${viewMode === 'grid' ? 'active' : ''}`} onClick={() => setViewMode('grid')}>üî≤ Grid</button><button className={`btn ${viewMode === 'table' ? 'active' : ''}`} onClick={() => setViewMode('table')}>üìã Table</button></div>
                                <button className="btn" onClick={handleNew}>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </div>
                        {viewMode === 'grid' ? (
                            <div className="grid-view">
                                {items.map(item => (
                                    <div key={item.id} className="card">
                                        <h3>{item.name || item.title}</h3>
                                        <p>{item.description || (item.content || '').substring(0, 100) + '...'}</p>
                                        <div style={{ marginTop: '15px' }}><button className="btn" onClick={() => handleEdit(item)}>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button className="btn btn-danger" onClick={() => handleDeleteItem(item.id, table, onUpdate, showMessage)}>üóëÔ∏è ‡∏•‡∏ö</button></div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="table-view">
                                <table>
                                    <thead><tr>{fields.map(f => <th key={f.name}>{f.label}</th>)}<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                    <tbody>
                                        {items.map(item => (
                                            <tr key={item.id}>
                                                {fields.map(f => <td key={f.name}>{item[f.name] || '-'}</td>)}
                                                <td><button className="btn" onClick={() => handleEdit(item)}>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button className="btn btn-danger" onClick={() => handleDeleteItem(item.id, table, onUpdate, showMessage)}>üóëÔ∏è ‡∏•‡∏ö</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                    {showModal && <div className="modal">
                        <div className="modal-content">
                            <h3>{editingItem ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç${title}` : `‡πÄ‡∏û‡∏¥‡πà‡∏°${title}‡πÉ‡∏´‡∏°‡πà`}</h3>
                            <form onSubmit={handleSubmit}>
                                {fields.map(field => (<div className="form-group" key={field.name}><label>{field.label} {field.required && '*'}</label>{renderField(field)}</div>))}
                                <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}><button type="button" className="btn" onClick={() => setShowModal(false)}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" className="btn btn-success">{editingItem ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡πÄ‡∏û‡∏¥‡πà‡∏°'}</button></div>
                            </form>
                        </div>
                    </div>}
                </div>
            );
        }

        const projectFields = [
            { name: 'name', label: '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ', required: true },
            { name: 'description', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', type: 'textarea' },
            { name: 'area_id', label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', type: 'select', options: 'areas' },
            { name: 'status', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', type: 'select-static', options: [{value: 'active', label: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}, {value: 'completed', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'}, {value: 'on-hold', label: '‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'}], initial: 'active' },
            { name: 'start_date', label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°', type: 'date' },
            { name: 'end_date', label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', type: 'date' }
        ];
        const areaFields = [ { name: 'name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', required: true }, { name: 'description', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', type: 'textarea' } ];
        const noteFields = [ { name: 'title', label: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', required: true }, { name: 'content', label: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', type: 'textarea', required: true }, { name: 'project_id', label: '‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ', type: 'select', options: 'projects' }, { name: 'area_id', label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', type: 'select', options: 'areas' } ];

        const ProjectManager = (props) => <GenericManager {...props} title="‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ" items={props.projects} table="projects" fields={projectFields} />;
        const AreaManager = (props) => <GenericManager {...props} title="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" items={props.areas} table="areas" fields={areaFields} />;
        const NoteManager = (props) => <GenericManager {...props} title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" items={props.notes} table="notes" fields={noteFields} />;

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>