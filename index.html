<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Brain - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        
        :root { 
            --primary: #78A3D4; 
            --primary-light: #CFE0EB; 
            --accent: #FF0000; 
            --link: #0000FF;
            --success: #008000;
            --warning: #FFA500;
            --dark: #000000; 
            --light: #F9FAFB;
            --white: #FFFFFF;
            --gray: #808080; 
        }

        body { font-family: 'Prompt', sans-serif; background-color: var(--light); color: var(--dark); }
        
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; border: none; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #6A93C2; }
        .btn-accent { background-color: var(--accent); color: white; }
        .btn-accent:hover { background-color: #E60000; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }

        .card { background-color: var(--white); border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.06); padding: 1.5rem; position: relative; }
        
        .sidebar { background: linear-gradient(135deg, #78A3D4 0%, #A6C3E4 100%); }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; margin: 0 0.5rem; border-radius: 0.5rem; color: var(--white); font-weight: 500; transition: all 0.2s; text-decoration: none; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); }
        .nav-link.active { background-color: rgba(255, 255, 255, 0.2); }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background-color: var(--white); border-radius: 0.75rem; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; transform: scale(0.95) translateY(10px); transition: transform 0.3s ease-in-out; }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }
        
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #555; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; font-size: 1rem; transition: all 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        
        .matrix-quadrant { min-height: 250px; background-color: #F8F9FA; border-radius: 0.5rem; }
        .task-card { background-color: var(--white); padding: 0.75rem 1rem; border-radius: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.08); cursor: grab; margin-bottom: 0.75rem; }
        .priority-task-card { border-left: 4px solid var(--accent); }
        
        .toast { position: fixed; bottom: 20px; right: 20px; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 100; opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        
        .text-link { color: var(--link); text-decoration: none; font-weight: 500; }
        .text-link:hover { text-decoration: underline; }

        .card-actions { position: absolute; top: 0.75rem; right: 0.75rem; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .card:hover .card-actions { opacity: 1; }
    </style>
</head>
<body>
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 sidebar shadow-lg flex flex-col">
            <div class="p-6 text-2xl font-bold text-white border-b border-white/20">Second Brain</div>
            <nav id="main-nav" class="flex-grow p-4 space-y-1">
                <a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt fa-fw w-6"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
                <a href="#monthly" class="nav-link"><i class="fas fa-calendar-alt fa-fw w-6"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a>
                <a href="#areas" class="nav-link"><i class="fas fa-layer-group fa-fw w-6"></i> Areas</a>
                <a href="#projects" class="nav-link"><i class="fas fa-tasks fa-fw w-6"></i> Projects</a>
                <a href="#tasks" class="nav-link"><i class="fas fa-check-circle fa-fw w-6"></i> Tasks</a>
                <a href="#notes" class="nav-link"><i class="fas fa-book fa-fw w-6"></i> Notes</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div id="page-content">
                <!-- Content will be injected here -->
            </div>
        </main>
    </div>

    <!-- Modal Placeholder -->
    <div id="modal-placeholder"></div>
    <div id="toast" class="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- SETUP ---
        // NOTE: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Supabase URL ‡πÅ‡∏•‡∏∞ Anon Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á
        const SUPABASE_URL = 'https://nevtnzjrbvgmirzxstqz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ldnRuempyYnZnbWlyenhzdHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjI2NjI2MjksImV4cCI6MjAzODIzODYyOX0.xUe-L0Unbusv_vYqPL2h2xIztc6Tj2w2Yj_2u7aA8eA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE & DOM ---
        let state = { areas: [], projects: [], tasks: [], notes: [], viewModes: { areas: 'card', projects: 'card' } };
        const pageContent = document.getElementById('page-content');
        const modalPlaceholder = document.getElementById('modal-placeholder');
        const toast = document.getElementById('toast');

        // --- TEMPLATES & RENDERING ---
        const templates = {
            dashboard: () => `
                <h1 class="text-3xl font-bold mb-6">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
                <h2 class="text-2xl font-bold mb-4">üî• ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</h2>
                <div id="priority-tasks" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
                
                <h2 class="text-2xl font-bold mb-4 mt-8">Eisenhower Matrix</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card"><h3 class="font-bold text-red-500 mb-4">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô & ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3><div id="urgent-important" class="matrix-quadrant p-4 space-y-3"></div></div>
                    <div class="card"><h3 class="font-bold text-blue-500 mb-4">‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô & ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3><div id="not-urgent-important" class="matrix-quadrant p-4 space-y-3"></div></div>
                    <div class="card"><h3 class="font-bold text-yellow-500 mb-4">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô & ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3><div id="urgent-not-important" class="matrix-quadrant p-4 space-y-3"></div></div>
                    <div class="card"><h3 class="font-bold text-gray-500 mb-4">‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô & ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3><div id="not-urgent-not-important" class="matrix-quadrant p-4 space-y-3"></div></div>
                </div>
            `,
            monthly: () => `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h1>
                    <div class="flex items-center gap-4">
                        <select id="month-filter" class="form-select w-40"></select>
                        <select id="year-filter" class="form-select w-32"></select>
                    </div>
                </div>
                <div id="monthly-stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
                <div id="monthly-tasks-table" class="bg-white rounded-xl shadow-md overflow-hidden"></div>
            `,
            areas: () => `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Areas</h1>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-secondary" onclick="app.toggleViewMode('areas')" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á"><i class="fas fa-table"></i></button>
                        <button class="btn btn-primary" onclick="app.openModal('area')"><i class="fas fa-plus"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Area ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
                <div id="areas-content"></div>
            `,
            projects: () => `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Projects</h1>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-secondary" onclick="app.toggleViewMode('projects')" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á"><i class="fas fa-table"></i></button>
                        <button class="btn btn-primary" onclick="app.openModal('project')"><i class="fas fa-plus"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Project ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
                <div id="projects-content"></div>
            `,
            tasks: () => `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">All Tasks</h1>
                    <button class="btn btn-primary" onclick="app.openModal('task')"><i class="fas fa-plus"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Task ‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div id="tasks-list" class="bg-white p-4 rounded-xl shadow-md"></div>
            `,
            notes: () => `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Notes</h1>
                    <button class="btn btn-primary" onclick="app.openModal('note')"><i class="fas fa-plus"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Note ‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            `,
            modal: (type, item = {}) => {
                const title = !item.id ? `‡∏™‡∏£‡πâ‡∏≤‡∏á ${app.getThaiName(type)}` : `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${app.getThaiName(type)}`;
                let fields = '';
                const areaOptions = state.areas.map(a => `<option value="${a.id}" ${item.area_id == a.id ? 'selected' : ''}>${a.name}</option>`).join('');
                const projectOptions = state.projects.map(p => `<option value="${p.id}" ${item.project_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('');

                switch (type) {
                    case 'area':
                        fields = `<div class="space-y-4">
                                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ Area</label><input type="text" name="name" class="form-input" value="${item.name || ''}" required></div>
                                    <div><label class="form-label">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Font Awesome)</label><input type="text" name="icon" class="form-input" value="${item.icon || 'fa-layer-group'}" placeholder="e.g., fa-briefcase"></div>
                                    <div><label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label><textarea name="description" class="form-textarea">${item.description || ''}</textarea></div>
                                  </div>`;
                        break;
                    case 'project':
                        fields = `<div class="space-y-4">
                                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ Project</label><input type="text" name="name" class="form-input" value="${item.name || ''}" required></div>
                                    <div><label class="form-label">Area</label><select name="area_id" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ --</option>${areaOptions}</select></div>
                                    <div><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select name="status" class="form-select">
                                        <option ${item.status === '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô' ? 'selected' : ''}>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</option>
                                        <option ${item.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                        <option ${item.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                    </select></div>
                                  </div>`;
                        break;
                    case 'task':
                        fields = `<div class="space-y-4">
                                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input type="text" name="title" class="form-input" value="${item.title || ''}" required></div>
                                    <div><label class="form-label">Project</label><select name="project_id" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ --</option>${projectOptions}</select></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label><select name="urgency" class="form-select">
                                            <option ${item.urgency === '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' ? 'selected' : ''}>‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
                                            <option ${item.urgency === '‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
                                        </select></div>
                                        <div><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><select name="priority" class="form-select">
                                            <option ${item.priority === '‡∏™‡∏π‡∏á' ? 'selected' : ''}>‡∏™‡∏π‡∏á</option>
                                            <option ${item.priority === '‡∏Å‡∏•‡∏≤‡∏á' ? 'selected' : ''}>‡∏Å‡∏•‡∏≤‡∏á</option>
                                            <option ${item.priority === '‡∏ï‡πà‡∏≥' ? 'selected' : ''}>‡∏ï‡πà‡∏≥</option>
                                        </select></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="date" name="due_date" class="form-input" value="${item.due_date || ''}"></div>
                                        <div><label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" name="duration" class="form-input" value="${item.duration || ''}" placeholder="e.g., 30"></div>
                                    </div>
                                  </div>`;
                        break;
                    case 'note':
                        const tagsValue = (item.tags && Array.isArray(item.tags)) ? item.tags.join(', ') : '';
                        fields = `<div class="space-y-4">
                                    <div><label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input type="text" name="title" class="form-input" value="${item.title || ''}" required></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">Area</label><select name="area_id" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ --</option>${areaOptions}</select></div>
                                        <div><label class="form-label">Project</label><select name="project_id" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ --</option>${projectOptions}</select></div>
                                    </div>
                                    <div><label class="form-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label><textarea name="content" class="form-textarea" rows="5">${item.content || ''}</textarea></div>
                                    <div><label class="form-label">‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)</label><input type="text" name="tags" class="form-input" value="${tagsValue}"></div>
                                  </div>`;
                        break;
                }

                return `<div id="modal-${type}" class="modal-overlay">
                            <div class="modal p-8">
                                <form id="form-${type}" data-id="${item.id || ''}" onsubmit="event.preventDefault(); app.saveItem('${type}')">
                                    <h3 class="text-2xl font-bold mb-6 text-gray-800">${title}</h3>
                                    ${fields}
                                    <div class="flex justify-end space-x-4 mt-8">
                                        <button type="button" class="btn btn-secondary" onclick="app.closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                    </div>
                                </form>
                            </div>
                        </div>`;
            },
            confirmModal: (type, item) => `
                <div id="modal-confirm" class="modal-overlay">
                    <div class="modal p-8 max-w-sm text-center">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2 text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
                        <p class="text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${item.name || item.title}"? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                        <div class="flex justify-center space-x-4">
                            <button type="button" class="btn btn-secondary" onclick="app.closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" id="confirm-delete-btn" class="btn btn-accent">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
                        </div>
                    </div>
                </div>
            `
        };

        const render = {
            dashboard: () => {
                pageContent.innerHTML = templates.dashboard();
                const priorityTasksContainer = document.getElementById('priority-tasks');
                const priorityTasks = (state.tasks || [])
                    .filter(t => t.priority === '‡∏™‡∏π‡∏á' && t.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')
                    .sort((a, b) => {
                        if (a.urgency === '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' && b.urgency !== '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô') return -1;
                        if (a.urgency !== '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' && b.urgency === '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô') return 1;
                        return new Date(a.created_at) - new Date(b.created_at);
                    })
                    .slice(0, 3);

                if (priorityTasks.length > 0) {
                    priorityTasksContainer.innerHTML = priorityTasks.map(task => {
                        const project = state.projects.find(p => p.id === task.project_id);
                        return `
                            <div class="card priority-task-card">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-gray-800">${task.title}</h4>
                                        <span class="text-sm text-gray-500">${project ? project.name : 'No Project'}</span>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <button onclick="app.openModal('task', '${task.id}')" class="text-gray-400 hover:text-primary" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô"><i class="fas fa-edit"></i></button>
                                        <button onclick="app.toggleTaskComplete('${task.id}')" class="text-gray-400 hover:text-green-500" title="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"><i class="fas fa-check-circle"></i></button>
                                        <button onclick="app.openConfirmModal('task', '${task.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö‡∏á‡∏≤‡∏ô"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    priorityTasksContainer.innerHTML = `<div class="card col-span-full text-center p-8 bg-green-50 text-green-700">
                        <i class="fas fa-glass-cheers text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</h3>
                    </div>`;
                }

                const quadrants = {
                    'urgent-important': document.getElementById('urgent-important'),
                    'not-urgent-important': document.getElementById('not-urgent-important'),
                    'urgent-not-important': document.getElementById('urgent-not-important'),
                    'not-urgent-not-important': document.getElementById('not-urgent-not-important'),
                };
                Object.keys(quadrants).forEach(key => {
                    const quadrantTasks = (state.tasks || [])
                        .filter(t => app.getQuadrantKey(t) === key && t.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')
                        .sort((a,b) => (a.display_order || 0) - (b.display_order || 0));

                    const container = quadrants[key];
                    container.innerHTML = ''; 
                    quadrantTasks.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'task-card';
                        taskEl.dataset.id = task.id;
                        const project = state.projects.find(p => p.id === task.project_id);
                        taskEl.innerHTML = `<div class="text-gray-800 font-medium">${task.title}</div><div class="text-xs text-gray-500 mt-1">${project ? project.name : 'No Project'}</div>`;
                        container.appendChild(taskEl);
                    });
                    app.initSortable(container, key);
                });
            },
            monthly: () => {
                pageContent.innerHTML = templates.monthly();
                const monthFilter = document.getElementById('month-filter');
                const yearFilter = document.getElementById('year-filter');
                const now = new Date();
                
                const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                monthFilter.innerHTML = months.map((m, i) => `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${m}</option>`).join('');

                const currentYear = now.getFullYear();
                for (let i = currentYear - 2; i <= currentYear + 2; i++) {
                    yearFilter.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i + 543}</option>`;
                }

                monthFilter.addEventListener('change', app.renderMonthlyData);
                yearFilter.addEventListener('change', app.renderMonthlyData);
                app.renderMonthlyData();
            },
            areas: () => {
                pageContent.innerHTML = templates.areas();
                const content = document.getElementById('areas-content');
                if (state.areas.length === 0) {
                    content.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md"><p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Area ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</p></div>`;
                    return;
                }
                if (state.viewModes.areas === 'card') {
                    content.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    content.innerHTML = state.areas.map(area => `
                        <div class="card">
                             <div class="card-actions">
                                 <button onclick="app.openModal('area', '${area.id}')" class="text-gray-400 hover:text-primary" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                                 <button onclick="app.openConfirmModal('area', '${area.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                             </div>
                            <h3 class="text-xl font-bold mb-2 text-gray-800"><i class="fas ${area.icon || 'fa-layer-group'} mr-3 text-primary"></i>${area.name}</h3>
                            <p class="text-gray-600">${area.description || ''}</p>
                        </div>
                    `).join('');
                } else {
                    content.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                    content.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left">
                        <thead><tr class="border-b bg-gray-50"><th class="p-4 font-semibold">Area</th><th class="p-4 font-semibold">Description</th><th class="p-4"></th></tr></thead>
                        <tbody>${state.areas.map(area => `
                            <tr class="border-b last:border-b-0 hover:bg-gray-50">
                                <td class="p-4 font-bold text-gray-800"><i class="fas ${area.icon || 'fa-layer-group'} mr-3 text-primary"></i>${area.name}</td>
                                <td class="p-4 text-gray-600">${area.description || ''}</td>
                                <td class="p-4 text-right">
                                    <button onclick="app.openModal('area', '${area.id}')" class="text-gray-400 hover:text-primary mr-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.openConfirmModal('area', '${area.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `).join('')}</tbody>
                    </table></div>`;
                }
            },
            projects: () => {
                pageContent.innerHTML = templates.projects();
                const content = document.getElementById('projects-content');
                if (state.projects.length === 0) {
                    content.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md"><p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Project ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</p></div>`;
                    return;
                }
                 if (state.viewModes.projects === 'card') {
                    content.className = 'space-y-4';
                    content.innerHTML = state.projects.map(p => {
                        const area = state.areas.find(a => a.id === p.area_id);
                        return `<div class="card">
                                    <div class="card-actions">
                                        <button onclick="app.openModal('project', '${p.id}')" class="text-gray-400 hover:text-primary" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                                        <button onclick="app.openConfirmModal('project', '${p.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                                    </div>
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800">${p.name}</h3>
                                            <span class="text-sm text-gray-500">${area ? `<i class="fas ${area.icon || 'fa-layer-group'} fa-fw"></i> ${area.name}` : 'No Area'}</span>
                                        </div>
                                        <span class="font-semibold text-sm rounded-full px-3 py-1 bg-primary-light text-primary">${p.status}</span>
                                    </div>
                                </div>`;
                    }).join('');
                } else {
                     content.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                     content.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left">
                         <thead><tr class="border-b bg-gray-50"><th class="p-4 font-semibold">Project</th><th class="p-4 font-semibold">Area</th><th class="p-4 font-semibold">Status</th><th class="p-4"></th></tr></thead>
                         <tbody>${state.projects.map(p => {
                             const area = state.areas.find(a => a.id === p.area_id);
                             return `<tr class="border-b last:border-b-0 hover:bg-gray-50">
                                 <td class="p-4 font-bold text-gray-800">${p.name}</td>
                                 <td class="p-4 text-gray-600">${area ? area.name : '-'}</td>
                                 <td class="p-4"><span class="font-semibold text-sm rounded-full px-3 py-1 bg-primary-light text-primary">${p.status}</span></td>
                                 <td class="p-4 text-right">
                                     <button onclick="app.openModal('project', '${p.id}')" class="text-gray-400 hover:text-primary mr-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                                     <button onclick="app.openConfirmModal('project', '${p.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                                 </td>
                             </tr>`;
                         }).join('')}</tbody>
                     </table></div>`;
                }
            },
            tasks: () => {
                pageContent.innerHTML = templates.tasks();
                const list = document.getElementById('tasks-list');
                if (state.tasks.length === 0) {
                    list.innerHTML = `<div class="text-center p-10"><p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Task ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</p></div>`;
                    return;
                }
                list.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left">
                                        <thead><tr class="border-b"><th class="p-3 font-semibold"></th><th class="p-3 font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th><th class="p-3 font-semibold">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</th><th class="p-3 font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th><th class="p-3 font-semibold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</th><th class="p-3"></th></tr></thead>
                                        <tbody>${state.tasks.map(t => {
                                            const project = state.projects.find(p => p.id === t.project_id);
                                            return `<tr class="border-b last:border-b-0 hover:bg-gray-50 ${t.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'opacity-50' : ''}">
                                                        <td class="p-3"><input type="checkbox" onchange="app.toggleTaskComplete('${t.id}')" ${t.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'checked' : ''} class="w-5 h-5"></td>
                                                        <td class="p-3 text-gray-800 ${t.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'line-through' : ''}">${t.title}</td>
                                                        <td class="p-3 text-gray-600">${project ? project.name : '-'}</td>
                                                        <td class="p-3"><button onclick="app.cycleTaskPriority('${t.id}')" class="font-semibold text-sm rounded-full px-3 py-1 ${t.priority === '‡∏™‡∏π‡∏á' ? 'bg-red-100 text-red-700' : t.priority === '‡∏Å‡∏•‡∏≤‡∏á' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">${t.priority}</button></td>
                                                        <td class="p-3 text-gray-600">${t.due_date || '-'}</td>
                                                        <td class="p-3 text-right">
                                                            <button onclick="app.openModal('task', '${t.id}')" class="text-gray-400 hover:text-primary mr-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                                                            <button onclick="app.openConfirmModal('task', '${t.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>`
                                        }).join('')}</tbody>
                                      </table></div>`;
            },
            notes: () => {
                pageContent.innerHTML = templates.notes();
                const grid = document.getElementById('notes-grid');
                 if (state.notes.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-lg shadow-md"><p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Note ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</p></div>`;
                    return;
                }
                grid.innerHTML = state.notes.map(note => {
                    const tagsArray = Array.isArray(note.tags) ? note.tags : [];
                    return `
                    <div class="card">
                        <div class="card-actions">
                            <button onclick="app.openModal('note', '${note.id}')" class="text-gray-400 hover:text-primary" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                            <button onclick="app.openConfirmModal('note', '${note.id}')" class="text-gray-400 hover:text-red-500" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                        </div>
                        <h3 class="text-lg font-bold mb-2 text-gray-800">${note.title}</h3>
                        <p class="text-gray-600 mb-4 h-20 overflow-hidden">${(note.content || '').substring(0,100)}${(note.content || '').length > 100 ? '...' : ''}</p>
                        <div class="flex flex-wrap gap-2">${tagsArray.map(tag => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">${tag}</span>`).join(' ')}</div>
                    </div>
                    `}).join('');
            }
        };

        // --- ROUTER ---
        const router = () => {
            const hash = window.location.hash.substring(1) || 'dashboard';
            if (render[hash]) {
                render[hash]();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[href="#${hash}"]`);
                if (activeLink) activeLink.classList.add('active');
            }
        };

        // --- API ---
        const api = {
            save: async (type, data) => {
                const tableName = `${type}s`;
                let response;
                if (data.id) {
                    const id = data.id;
                    delete data.id;
                    response = await supabaseClient.from(tableName).update(data).eq('id', id).select();
                } else {
                    response = await supabaseClient.from(tableName).insert([data]).select();
                }
                if (response.error) throw response.error;
                return response.data;
            },
            delete: async (type, id) => {
                const tableName = `${type}s`;
                const { error } = await supabaseClient.from(tableName).delete().eq('id', id);
                if (error) throw error;
            }
        };

        // --- APP LOGIC ---
        const app = {
            init: async () => {
                window.addEventListener('hashchange', router);
                await app.refreshData();
                await app.checkTaskPromotions();
                router();
            },
            refreshData: async () => {
                try {
                    const [areas, projects, tasks, notes] = await Promise.all([
                        supabaseClient.from('areas').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('projects').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('tasks').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('notes').select('*').order('created_at', { ascending: false }),
                    ]);
                    state = { ...state, areas: areas.data, projects: projects.data, tasks: tasks.data, notes: notes.data };
                } catch (error) {
                    app.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`, 'error');
                }
            },
            renderMonthlyData: () => {
                const month = document.getElementById('month-filter').value;
                const year = document.getElementById('year-filter').value;
                
                const filteredTasks = state.tasks.filter(t => {
                    if (!t.due_date) return false;
                    const dueDate = new Date(t.due_date);
                    return dueDate.getMonth() == month && dueDate.getFullYear() == year;
                });

                const completedTasks = filteredTasks.filter(t => t.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;
                const totalTasks = filteredTasks.length;
                const successRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                document.getElementById('monthly-stats').innerHTML = `
                    <div class="card text-center"><div class="text-3xl font-bold text-gray-800">${totalTasks}</div><div class="text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                    <div class="card text-center"><div class="text-3xl font-bold" style="color:var(--success);">${completedTasks}</div><div class="text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div></div>
                    <div class="card text-center"><div class="text-3xl font-bold text-primary">${successRate}%</div><div class="text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>
                `;

                const tableContainer = document.getElementById('monthly-tasks-table');
                if(filteredTasks.length === 0){
                    tableContainer.innerHTML = `<div class="text-center p-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`;
                    return;
                }
                tableContainer.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left">
                    <thead><tr class="border-b bg-gray-50"><th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th><th class="p-3">Project</th><th class="p-3">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th><th class="p-3">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</th></tr></thead>
                    <tbody>${filteredTasks.map(t => {
                        const project = state.projects.find(p => p.id === t.project_id);
                        return `<tr class="border-b last:border-b-0 hover:bg-gray-50">
                                    <td class="p-3"><input type="checkbox" onchange="app.toggleTaskComplete('${t.id}')" ${t.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'checked' : ''} class="w-5 h-5"></td>
                                    <td class="p-3 text-gray-800">${t.title}</td>
                                    <td class="p-3">${project ? project.name : '-'}</td>
                                    <td class="p-3 text-gray-600">${t.priority}</td>
                                    <td class="p-3 text-gray-600">${t.due_date || '-'}</td>
                                </tr>`
                    }).join('')}</tbody>
                </table></div>`;
            },
            updateTask: async (id, data, message) => {
                 try {
                     const { error } = await supabaseClient.from('tasks').update(data).eq('id', id);
                     if (error) throw error;
                     if (message) app.showToast(message, 'success');
                     await app.refreshData();
                     router();
                 } catch (error) {
                     app.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                 }
            },
            toggleTaskComplete: async (id) => {
                const task = state.tasks.find(t => t.id == id);
                if (!task) return;
                const newStatus = task.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                const message = newStatus === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üéâ' : '‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                await app.updateTask(id, { status: newStatus }, message);
            },
            cycleTaskPriority: async (id) => {
                const task = state.tasks.find(t => t.id == id);
                if (!task) return;
                const priorityCycle = ['‡∏™‡∏π‡∏á', '‡∏Å‡∏•‡∏≤‡∏á', '‡∏ï‡πà‡∏≥'];
                const currentPriorityIndex = priorityCycle.indexOf(task.priority);
                const nextPriorityIndex = (currentPriorityIndex + 1) % priorityCycle.length;
                const nextPriority = priorityCycle[nextPriorityIndex];
                await app.updateTask(id, { priority: nextPriority }, `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏õ‡πá‡∏ô: ${nextPriority}`);
            },
            checkTaskPromotions: async () => {
                const today = new Date();
                const threshold = new Date();
                threshold.setDate(today.getDate() + 3);

                if (!state.tasks || !Array.isArray(state.tasks)) return;

                const tasksToPromote = state.tasks.filter(t => 
                    t.priority === '‡∏™‡∏π‡∏á' && 
                    t.urgency === '‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' && 
                    t.due_date && 
                    new Date(t.due_date) <= threshold
                );

                if (tasksToPromote.length > 0) {
                    const updates = tasksToPromote.map(t => ({ id: t.id, urgency: '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' }));
                    const { error } = await supabaseClient.from('tasks').upsert(updates, { onConflict: 'id' });
                    if (error) {
                        app.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô', 'error');
                    } else {
                        app.showToast(`‡∏°‡∏µ ${tasksToPromote.length} ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô!`, 'success');
                        await app.refreshData();
                        router();
                    }
                }
            },
            openModal: (type, id = null) => {
                const item = id ? state[`${type}s`].find(i => i.id == id) : {};
                modalPlaceholder.innerHTML = templates.modal(type, item || {});
                setTimeout(() => {
                    const modalOverlay = modalPlaceholder.querySelector('.modal-overlay');
                    if (modalOverlay) modalOverlay.classList.add('active');
                }, 10);
            },
            closeModal: () => {
                const modalOverlay = modalPlaceholder.querySelector('.modal-overlay');
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    setTimeout(() => {
                        modalPlaceholder.innerHTML = '';
                    }, 300);
                }
            },
            openConfirmModal: (type, id) => {
                const item = state[`${type}s`].find(i => i.id == id);
                if (!item) return;
                modalPlaceholder.innerHTML = templates.confirmModal(type, item);
                document.getElementById('confirm-delete-btn').onclick = () => app.deleteItem(type, id);
                 setTimeout(() => {
                    const modalOverlay = modalPlaceholder.querySelector('.modal-overlay');
                    if (modalOverlay) modalOverlay.classList.add('active');
                }, 10);
            },
            saveItem: async (type) => {
                const form = document.getElementById(`form-${type}`);
                const id = form.dataset.id;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                if (id) data.id = id;

                // Data cleaning
                if (data.tags) {
                    data.tags = data.tags.split(',').map(t => t.trim()).filter(Boolean);
                }
                for (const key of ['area_id', 'project_id']) {
                    if (data[key] === '') data[key] = null;
                }
                 if (data.due_date === '') data.due_date = null;


                try {
                    await api.save(type, data);
                    app.showToast(`${app.getThaiName(type)}‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    app.closeModal();
                    await app.refreshData();
                    router();
                } catch (error) {
                    app.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                }
            },
            deleteItem: async (type, id) => {
                try {
                    await api.delete(type, id);
                    app.showToast(`‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    app.closeModal();
                    await app.refreshData();
                    router();
                } catch (error) {
                    app.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`, 'error');
                }
            },
            showToast: (message, type = 'success') => {
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },
            getThaiName: (type) => {
                const names = { area: 'Area', project: 'Project', task: 'Task', note: 'Note' };
                return names[type] || type;
            },
            toggleViewMode: (type) => {
                state.viewModes[type] = state.viewModes[type] === 'card' ? 'table' : 'card';
                render[type]();
            },
            getQuadrantKey: (task) => {
                const isImportant = task.priority === '‡∏™‡∏π‡∏á';
                const isUrgent = task.urgency === '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô';
                if (isUrgent && isImportant) return 'urgent-important';
                if (!isUrgent && isImportant) return 'not-urgent-important';
                if (isUrgent && !isImportant) return 'urgent-not-important';
                if (!isUrgent && !isImportant) return 'not-urgent-not-important';
                return 'not-urgent-not-important';
            },
            initSortable: (container, quadrantKey) => {
                new Sortable(container, {
                    group: 'matrix-tasks',
                    animation: 150,
                    onEnd: async (evt) => {
                        const { to, item } = evt;
                        const taskId = item.dataset.id;
                        const newQuadrantKey = to.id;

                        const newProperties = {};
                        switch(newQuadrantKey) {
                            case 'urgent-important': newProperties.urgency = '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô'; newProperties.priority = '‡∏™‡∏π‡∏á'; break;
                            case 'not-urgent-important': newProperties.urgency = '‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô'; newProperties.priority = '‡∏™‡∏π‡∏á'; break;
                            case 'urgent-not-important': newProperties.urgency = '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô'; newProperties.priority = '‡∏Å‡∏•‡∏≤‡∏á'; break;
                            case 'not-urgent-not-important': newProperties.urgency = '‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô'; newProperties.priority = '‡∏ï‡πà‡∏≥'; break;
                        }
                        
                        await app.updateTask(taskId, newProperties, '‡∏¢‡πâ‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Matrix ‡πÅ‡∏•‡πâ‡∏ß');
                    }
                });
            },
        };

        window.app = app; // Expose app to global scope for onclick handlers
        app.init();
    });
    </script>
</body>
</html>
